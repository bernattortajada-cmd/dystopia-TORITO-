<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PRESENCIA v3 â€” texto generativo</title>
<style>
  :root{--bg:#0a0a0b;--fg:#e8e8ec}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
  .stage{position:relative;width:min(94vw,560px);aspect-ratio:9/16;border-radius:20px;
    overflow:hidden;background:#000;box-shadow:0 18px 48px rgba(0,0,0,.5)}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);opacity:0.05}
  canvas{position:absolute;inset:0;width:100%;height:100%}
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);z-index:9;cursor:pointer;text-align:center}
  .cta{background:#ffffff12;border:1px solid #ffffff2d;color:#fff;padding:14px 18px;border-radius:14px;
    font-size:16px;backdrop-filter:blur(6px)}
  .hud{position:absolute;left:10px;right:10px;bottom:10px;display:flex;justify-content:space-between;
    font-size:12px;opacity:.9;mix-blend-mode:screen}
  .pill{border:1px solid #2c2c30;background:#141417;padding:6px 10px;border-radius:999px}
  .log{max-width:560px;width:100%;margin-top:12px;background:#0e0e11;border:1px solid #26262b;border-radius:12px;
    padding:10px;font-size:12px;line-height:1.35;white-space:pre-wrap}
  .ok{color:#9BEF8A}.warn{color:#FFD166}.err{color:#FF6B6B}

  /* Overlay de texto poÃ©tico */
  #textOverlay{
    position:absolute; inset:auto 12px 64px 12px;
    text-align:center; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    font-size:14px; line-height:1.4; letter-spacing:0.2px;
    color:#eaeaf0; opacity:0; transform: translateY(6px);
    transition: opacity .5s ease, transform .5s ease;
    text-shadow: 0 1px 0 rgba(0,0,0,.25);
    pointer-events:none; mix-blend-mode:screen;
  }
  #textOverlay.show{ opacity:1; transform: translateY(0); }
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <video id="cam" playsinline muted></video>
    <canvas id="viz"></canvas>
    <div class="overlay" id="ovl"><div class="cta">Toca aquÃ­ para activar cÃ¡mara + audio</div></div>
    <div class="hud">
      <div class="pill" id="state">estado: idle</div>
      <div class="pill" id="meters">browÎ”: - Â· mouth: -</div>
    </div>
    <div id="textOverlay"></div>
  </div>
  <div class="log" id="log"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script>
// ======== Log util ========
const logEl=document.getElementById('log');
function log(m,c=''){const d=document.createElement('div');d.className=c;d.textContent=m;
logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}

// ======== Audio simple (sin samples externos para demo) ========
let actx,gMaster,gDrone,osc,started=false;
function ctx(){return actx||(actx=new (window.AudioContext||window.webkitAudioContext)());}
function silentClick(){const c=ctx();const o=c.createOscillator();const g=c.createGain();
g.gain.value=0.0001;o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.05);}
async function unlock(){ctx();silentClick();try{await actx.resume();}catch{}}
function initAudio(){
  const c=ctx();
  gMaster=c.createGain();gMaster.gain.value=0;gMaster.connect(c.destination);
  osc=c.createOscillator();osc.type='sine';osc.frequency.value=110;gDrone=c.createGain();gDrone.gain.value=0;
  osc.connect(gDrone).connect(gMaster);osc.start();
}
function ramp(g,to,t=0.6){const c=ctx();const now=c.currentTime;
g.cancelScheduledValues(now);g.setValueAtTime(g.value,now);g.linearRampToValueAtTime(to,now+t);}
function setPresenceAudio(on){
  ramp(gMaster.gain,on?0.8:0.0,0.8);
  ramp(gDrone.gain,on?0.3:0.0,0.8);
}

// ======== Texto generativo ========
const textEl=document.getElementById('textOverlay');
const PHRASES=[
 "has sido un torito bravo durante {{t}} segundos.",
 "Los sueÃ±os caen del cielo.",
 "cierro los ojos, cuando los abro, salen modelos de los cuadros"
];
let textTimer=null,presentStartMs=0,phraseIndex=0;
function renderPhrase(){
  const now=performance.now();
  const tSec=presentStartMs?Math.max(0,Math.floor((now-presentStartMs)/1000)):0;
  const raw=PHRASES[phraseIndex%PHRASES.length];
  const msg=raw.replace(/\{\{\s*t\s*\}\}/g,String(tSec));
  phraseIndex++;
  textEl.textContent=msg;
}
function startTextLoop(){
  if(textTimer) return;
  renderPhrase();
  textTimer=setInterval(renderPhrase,9000);
}
function stopTextLoop(){
  if(textTimer){clearInterval(textTimer);textTimer=null;}
}

// ======== FaceMesh detecciÃ³n simple ========
const video=document.getElementById('cam');
const canvas=document.getElementById('viz');
const ctx2d=canvas.getContext('2d');
const ovl=document.getElementById('ovl');
const stage=document.getElementById('stage');
const stateEl=document.getElementById('state');
const metersEl=document.getElementById('meters');

let faceMesh,present=false,lastSeen=0,seenCount=0;
let browsEMA=0,browBase=0,browFrames=0,browCalibrated=false,browsUp=false;
let mouthEMA=0,mouthOpen=false,lastNose=null,motionEMA=0;
const NOSE=1,CHIN=152,MOUTH_TOP=13,MOUTH_BOTTOM=14;
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const lerp=(a,b,t)=>a+(b-a)*t;

// presencia global
function setPresence(on){
  stateEl.textContent='estado: '+(on?'presente':'ausente');
  setPresenceAudio(on);
  if(on){
    presentStartMs=performance.now();
    textEl.classList.add('show');
    startTextLoop();
  }else{
    textEl.classList.remove('show');
    stopTextLoop();
  }
}

function drawBG(t,motion){
  const w=canvas.width=stage.clientWidth*2,h=canvas.height=stage.clientHeight*2;
  const cx=ctx2d;
  const cn=(Math.sin(t*0.0006)+1)/2;
  const m=Math.min(1,motion*2.0);
  const hue=(200+80*cn+100*m)%360;
  const sat=16+36*m,lit=8+18*cn+12*m;
  const grd=cx.createRadialGradient(w*0.5,h*(0.38+0.12*m),w*0.08,w*0.5,h*0.62,Math.max(w,h)*0.8);
  grd.addColorStop(0,`hsla(${hue},${sat+18}%,${Math.min(92,lit+30)}%,${0.16+0.22*m})`);
  grd.addColorStop(1,`hsla(${(hue+180)%360},${sat}%,${Math.max(5,lit-5)}%,${0.96})`);
  cx.fillStyle=grd;cx.fillRect(0,0,w,h);
}

function onResults(res){
  const t=performance.now();
  const hasFace=res&&res.multiFaceLandmarks&&res.multiFaceLandmarks.length>0;
  if(hasFace){
    seenCount++;lastSeen=t;
    const lm=res.multiFaceLandmarks[0];
    const scale=dist(lm[NOSE],lm[CHIN]);
    const nose=lm[NOSE];
    if(lastNose){
      const d=Math.hypot(nose.x-lastNose.x,nose.y-lastNose.y);
      motionEMA=motionEMA*0.85+d*0.15;
    }
    lastNose={x:nose.x,y:nose.y};
    // cejas
    const browY=(lm[10].y+lm[67].y+lm[297].y)/3;
    const eyeY=(lm[159].y+lm[386].y)/2;
    const browLift=(eyeY-browY)/scale;
    browsEMA=lerp(browsEMA,browLift,0.25);
    if(!browCalibrated){browBase+=browsEMA;browFrames++;if(browFrames>70){browBase/=browFrames;browCalibrated=true;log('Cejas calibradas âœ…','ok');}}
    const liftDelta=browsEMA-browBase;
    const raiseT=0.12,lowerT=0.08;
    let browsUpNow=browsUp;
    if(!browsUp&&liftDelta>raiseT)browsUpNow=true;
    if(browsUp&&liftDelta<lowerT)browsUpNow=false;
    browsUp=browsUpNow;
    // boca
    const mDist=dist(lm[MOUTH_TOP],lm[MOUTH_BOTTOM])/scale;
    mouthEMA=lerp(mouthEMA,mDist,0.35);
    const mouthOpenNow=mouthEMA>0.34;
    if(mouthOpenNow!==mouthOpen)mouthOpen=mouthOpenNow;
    if(!present&&seenCount>6){present=true;setPresence(true);}
  }else{
    seenCount=0;lastNose=null;motionEMA=0;
    if(present&&(performance.now()-lastSeen)>900){present=false;setPresence(false);}
  }
  drawBG(performance.now(),motionEMA);
  metersEl.textContent=`browÎ”: ${(browsEMA-browBase).toFixed(3)} Â· mouth: ${mouthEMA.toFixed(3)}`;
}

// start
async function start(){
  if(started)return;started=true;
  await unlock();initAudio();
  log('AudioContext: '+ctx().state,'ok');
  log('Pidiendo cÃ¡maraâ€¦','warn');
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:720},height:{ideal:1280}},audio:false});
  const watchdog=setTimeout(()=>{ovl.style.display='flex';started=false;},5000);
  video.srcObject=stream;await video.play();clearTimeout(watchdog);
  ovl.style.display='none';
  faceMesh=new FaceMesh({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${f}`});
  faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.6,minTrackingConfidence:0.6});
  faceMesh.onResults(onResults);
  new Camera(video,{onFrame:async()=>{await faceMesh.send({image:video});}}).start();
  setPresence(false);
  log('Sistema listo âœ…','ok');
}
document.getElementById('stage').addEventListener('pointerdown',start,{once:false});
drawBG(performance.now(),0);
log('Tip: desactiva el modo silencio ðŸ”Š','warn');
</script>
</body>
</html>
