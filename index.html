<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>PRESENCIA v6 — iOS fix + Times + texto vivo</title>
<style>
  :root{--bg:#0a0a0b;--fg:#e8e8ec}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
  .stage{position:relative;width:min(94vw,560px);aspect-ratio:9/16;border-radius:20px;
    overflow:hidden;background:#000;box-shadow:0 18px 48px rgba(0,0,0,.5)}
  /* vídeo un poco más visible */
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
    transform:scaleX(-1);opacity:0.18}
  canvas{position:absolute;inset:0;width:100%;height:100%}
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.55);z-index:9;cursor:pointer;text-align:center}
  .cta{background:#ffffff12;border:1px solid #ffffff2d;color:#fff;padding:14px 18px;border-radius:14px;
    font-size:16px;backdrop-filter:blur(6px)}
  .hud{position:absolute;left:10px;right:10px;bottom:10px;display:flex;
    justify-content:space-between;font-size:12px;opacity:.9;mix-blend-mode:screen}
  .pill{border:1px solid #2c2c30;background:#141417;padding:6px 10px;border-radius:999px}
  .log{max-width:560px;width:100%;margin-top:12px;background:#0e0e11;
    border:1px solid #26262b;border-radius:12px;padding:10px;font-size:12px;line-height:1.35;white-space:pre-wrap}
  .ok{color:#9BEF8A}.warn{color:#FFD166}.err{color:#FF6B6B}

  /* Texto poético en Times + respiración */
  #textOverlay{
    position:absolute;inset:auto 12px 64px 12px;text-align:center;
    font-family:"Times New Roman", Times, serif;
    font-size:16px; line-height:1.5;
    color:#f0f0f4; opacity:0; transform:translateY(6px);
    transition:opacity .6s ease,transform .6s ease, filter .2s ease;
    pointer-events:none;mix-blend-mode:screen;text-shadow:0 1px 0 rgba(0,0,0,.25);
  }
  #textOverlay.show{
    opacity:1; transform:translateY(0);
    animation:breathe 6s ease-in-out infinite;
  }
  @keyframes breathe{
    0%,100%{ opacity:.9; transform:translateY(2px);}
    50%{    opacity:1;  transform:translateY(-2px);}
  }

  /* iOS: evitar selección/tap highlight */
  .stage, .overlay, .cta {
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage">
    <video id="cam" playsinline webkit-playsinline autoplay muted></video>
    <canvas id="viz"></canvas>
    <div class="overlay" id="ovl"><div class="cta">Toca aquí para activar cámara + audio</div></div>
    <div class="hud">
      <div class="pill" id="state">estado: idle</div>
      <div class="pill" id="meters">browΔ: - · mouth: -</div>
    </div>
    <div id="textOverlay"></div>
  </div>
  <div class="log" id="log"></div>
</div>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script>
/*  PRESENCIA v6 (iOS safe): Times + texto “respira” + blur por movimiento + audio loops con gestos  */
const logEl=document.getElementById('log');
function log(m,c=''){const d=document.createElement('div');d.className=c;d.textContent=m;
logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}

// — Audio (loops con fallback) —
let actx;function ctx(){return actx||(actx=new (window.AudioContext||window.webkitAudioContext)());}
function silentClick(){const c=ctx();const o=c.createOscillator();const g=c.createGain();
g.gain.value=0.0001;o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.05);}
async function unlock(){ctx();silentClick();try{await actx.resume();}catch{} log('AudioContext: '+actx.state,actx.state==='running'?'ok':'warn');return actx.state==='running';}
async function loadBuffer(name){
  for(const ext of ['wav','mp3']){
    try{
      const r=await fetch(`assets/${name}.${ext}`,{cache:'no-store'});
      if(r.ok){const a=await r.arrayBuffer();return await ctx().decodeAudioData(a);}
    }catch{}
  }
  throw new Error('No pude cargar '+name);
}
function makeLoop(b,v=0){const c=ctx();const s=c.createBufferSource();s.buffer=b;s.loop=true;const g=c.createGain();g.gain.value=v;s.connect(g).connect(c.destination);s.start();return{src:s,gain:g};}
function ramp(p,v,t=0.4){const c=ctx();const n=c.currentTime;p.cancelScheduledValues(n);p.setValueAtTime(p.value,n);p.linearRampToValueAtTime(v,n+t);}
function trig(b,v=0.9){const c=ctx();const s=c.createBufferSource();const g=c.createGain();g.gain.value=v;s.buffer=b;s.connect(g).connect(c.destination);s.start();s.stop(c.currentTime+(b.duration||3));}

// Archivos
const LOOPS=['breath_drone_base','breath_air_noise','sub_pulse_loop','texture_hiss_loop','kinetic_click_loop','kinetic_foley_loop'];
const GRAINS=['choir_grain_01','choir_grain_02','choir_grain_03','choir_grain_04'];
let loops={},grains={},audioReady=false;
// niveles un pelín más claros
const LEVELS={breath_drone_base:.38,breath_air_noise:.16,sub_pulse_loop:.32,texture_hiss_loop:.12,kinetic_click_loop:.20,kinetic_foley_loop:0};

async function loadAll(){log('Cargando audio…','warn');
  const b=await Promise.all(LOOPS.map(n=>loadBuffer(n))); LOOPS.forEach((n,i)=>loops[n]=makeLoop(b[i],0));
  const g=await Promise.all(GRAINS.map(n=>loadBuffer(n).catch(()=>null))); GRAINS.forEach((n,i)=>{if(g[i])grains[n]=g[i];});
  audioReady=true; log('Audio listo ✅','ok');
}

function setPresence(on){
  stateEl.textContent='estado: '+(on?'presente':'ausente');
  if(!audioReady) return;
  for(const n in LEVELS) ramp(loops[n].gain.gain, on?LEVELS[n]:0, 0.7);
  // texto ON/OFF
  if(on){ presentStart=performance.now(); textEl.classList.add('show'); startText(); }
  else  { stopText(); textEl.classList.remove('show'); }
}
function setMouth(o){ if(audioReady) ramp(loops['kinetic_foley_loop'].gain.gain, o?.32:0, .2); }
function grain(){ const k=Object.keys(grains); if(!k.length) return; trig(grains[k[Math.floor(Math.random()*k.length)]], .85); }
function motionMod(m){
  if(!audioReady) return;
  ramp(loops['texture_hiss_loop'].gain.gain, Math.min(.25,.10+m*1.0), .2);
  ramp(loops['kinetic_click_loop'].gain.gain, Math.min(.30,.14+m*1.3), .15);
}

// — Texto —
const textEl=document.getElementById('textOverlay');
const PHRASES=[
  "has sido un torito bravo durante {{t}} segundos.",
  "Los sueños caen del cielo.",
  "cierro los ojos, cuando los abro, salen modelos de los cuadros."
];
let textTimer=null,presentStart=0,phraseIndex=0;
function renderPhrase(){const tSec=Math.floor((performance.now()-presentStart)/1000);
  textEl.textContent=PHRASES[phraseIndex%PHRASES.length].replace(/\{\{\s*t\s*\}\}/g,tSec);
  phraseIndex++;
}
function startText(){ if(textTimer) return; renderPhrase(); textTimer=setInterval(renderPhrase,9000); }
function stopText(){ if(textTimer){ clearInterval(textTimer); textTimer=null; } }

// — Visual + Gestos —
const video=document.getElementById('cam'),canvas=document.getElementById('viz'),ctx2d=canvas.getContext('2d'),ovl=document.getElementById('ovl'),stage=document.getElementById('stage'),stateEl=document.getElementById('state'),metersEl=document.getElementById('meters');
let faceMesh,started=false,present=false,lastSeen=0,seen=0,browsEMA=0,browBase=0,browFrames=0,browCal=false,browsUp=false,mouthEMA=0,mouthOpen=false,lastNose=null,motionEMA=0;
const N=1,C=152,MT=13,MB=14,LE=159,RE=386; const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y), lerp=(a,b,t)=>a+(b-a)*t;

function bg(t,m){
  const w=canvas.width=stage.clientWidth*2, h=canvas.height=stage.clientHeight*2, cx=ctx2d;
  const cn=(Math.sin(t*0.0006)+1)/2, M=Math.min(1,m*2);
  // fondo un poco más claro
  const hue=(210+70*cn+80*M)%360, sat=20+40*M, lit=12+22*cn+16*M;
  const grd=cx.createRadialGradient(w*.5, h*(.36+.10*M), w*.08, w*.5, h*.60, Math.max(w,h)*.8);
  grd.addColorStop(0, `hsla(${hue}, ${sat+18}%, ${Math.min(94,lit+28)}%, ${.18+.24*M})`);
  grd.addColorStop(1, `hsla(${(hue+180)%360}, ${sat}%, ${Math.max(7,lit-4)}%, ${.95})`);
  cx.fillStyle=grd; cx.fillRect(0,0,w,h);
  // blur del texto según movimiento
  textEl.style.filter = `blur(${(M*1.8).toFixed(2)}px)`;
  // (opcional) velocidad de respiración dinámica:
  const dur = Math.max(1.6, 2.8 - M*1.3);
  textEl.style.animationDuration = `${dur.toFixed(2)}s`;
}

function onResults(r){
  const t=performance.now(), f=r&&r.multiFaceLandmarks&&r.multiFaceLandmarks[0];
  if(f){
    seen++; lastSeen=t;
    const s=dist(f[N],f[C]), nose=f[N];
    if(lastNose){
      const d=Math.hypot(nose.x-lastNose.x,nose.y-lastNose.y);
      motionEMA = motionEMA*0.85 + d*0.15;
      motionMod(motionEMA);
    }
    lastNose={x:nose.x,y:nose.y};

    // cejas
    const browY=(f[10].y+f[67].y+f[297].y)/3, eyeY=(f[LE].y+f[RE].y)/2;
    const browLift=(eyeY-browY)/s; browsEMA=lerp(browsEMA,browLift,.25);
    if(!browCal){browBase+=browsEMA;browFrames++; if(browFrames>70){browBase/=browsEMA?browFrames:1; browCal=true; log('Cejas calibradas ✅','ok');}}
    const dlt=browsEMA-browBase;
    if(!browsUp && dlt>0.12){browsUp=true; grain();}
    if(browsUp && dlt<0.08){browsUp=false;}

    // boca
    const mD=dist(f[MT],f[MB])/s; mouthEMA=lerp(mouthEMA,mD,.35);
    const mO=mouthEMA>0.34; if(mO!==mouthOpen){mouthOpen=mO; setMouth(mouthOpen);}

    if(!present && seen>=6){present=true; setPresence(true);}
  }else{
    seen=0; lastNose=null; motionEMA=0;
    if(present && (performance.now()-lastSeen)>900){present=false; setPresence(false);}
  }
  bg(performance.now(), motionEMA);
  metersEl.textContent=`browΔ: ${(browsEMA-browBase).toFixed(3)} · mouth: ${mouthEMA.toFixed(3)}`;
}

// —— iOS-safe START (multi-listener + doble unlock + watchdog + mensajes claros) ——
async function start(){
  if (window.__starting__) return;
  window.__starting__ = true;

  try{
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      throw new Error('Este navegador no permite cámara (revisa iOS/Safari).');
    }

    // Desbloqueo de audio doble (osc + buffer 50ms)
    await unlock();
    { const c=ctx(); const silent=c.createBuffer(1, Math.max(1, c.sampleRate*0.05), c.sampleRate);
      const src=c.createBufferSource(); src.buffer=silent; src.connect(c.destination); src.start(0);
      try{ await c.resume(); }catch{} }
    log('AudioContext: '+ctx().state, ctx().state==='running'?'ok':'warn');

    if(!audioReady) await loadAll();

    log('Pidiendo cámara…','warn');
    const constraints={ video:{facingMode:'user',width:{ideal:720},height:{ideal:1280}}, audio:false };
    const stream=await navigator.mediaDevices.getUserMedia(constraints);

    const watchdog=setTimeout(()=>{
      ovl.style.display='flex';
      ovl.querySelector('.cta').textContent='No se pudo iniciar la cámara. Toca para reintentar (revisa permisos).';
      log('Watchdog: la cámara no inició en 6s','err');
      window.__starting__=false;
    },6000);

    const v=document.getElementById('cam');
    v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline',''); v.setAttribute('autoplay',''); v.muted=true;
    v.srcObject=stream; await v.play();
    clearTimeout(watchdog);

    ovl.style.display='none';
    log('Cámara OK ✅','ok');

    if(!window.__fmReady__){
      const fm=new FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${f}`});
      fm.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.6,minTrackingConfidence:0.6});
      fm.onResults(onResults);
      new Camera(v,{onFrame:async()=>{await fm.send({image:v});}}).start();
      window.__fmReady__=true;
    }

    setPresence(false);
    log('Sistema listo ✅ · mira a cámara','ok');
  }catch(e){
    const msg=String(e&&e.message||e);
    if(/NotAllowedError|denied|Permission/i.test(msg)){
      log('Permiso de cámara denegado. Pulsa el candado → “Permisos” → Cámara: Permitir.', 'err');
    }else if(/NotFoundError|no device|overconstrained/i.test(msg)){
      log('No se encontró cámara frontal. Cierra otras apps que usen cámara y reintenta.', 'err');
    }else{
      log('Error: '+msg,'err');
    }
    ovl.style.display='flex';
    ovl.querySelector('.cta').textContent='Toca para reintentar (revisa permisos/caché)';
    window.__starting__=false;
  }
}

// multi-listener robusto para iOS
function bindStartListeners(){
  const fire=(e)=>{ e.preventDefault(); start(); };
  ['pointerdown','touchend','click'].forEach(ev=>{
    document.getElementById('ovl').addEventListener(ev, fire, { passive:false });
    document.getElementById('stage').addEventListener(ev, fire, { passive:false });
    document.body.addEventListener(ev, fire, { passive:false });
  });
}
bindStartListeners();

// primer fondo y tip
bg(performance.now(), 0);
log('Tip: sube volumen y quita modo silencio 🔊','warn');
</script>
</body>
</html>
